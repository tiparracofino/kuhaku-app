<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F7F5F0">
    <title>空白 Kūhaku</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;300;400;700;900&family=Shippori+Mincho:wght@400;700;800&family=Noto+Sans:wght@300;400;600;700&display=swap');

        :root {
            --washi: #F7F5F0;
            --washi-warm: #F0EDE5;
            --ink: #0a0a0a;
            --ink-soft: #1a1a1a;
            --vermillion: #C83232;
            --vermillion-pale: rgba(200,50,50,0.06);
            --indigo: #6B8FA3;
            --indigo-light: #8FB4C9;
            --indigo-pale: #A8C8D8;
            --indigo-ghost: rgba(107,143,163,0.12);
            --white: #FFFFFF;
            --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
            --radius: 4px;
            --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            background: var(--washi);
            color: var(--ink);
            font-family: 'Noto Sans', sans-serif;
            overflow: hidden; /* Evita rebote elástico global */
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            opacity: 0.35;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='f'%3E%3CfeTurbulence baseFrequency='0.65' numOctaves='4' seed='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='256' height='256' filter='url(%23f)' opacity='0.035'/%3E%3C/svg%3E");
        }

        .jp { font-family: 'Shippori Mincho', 'Noto Serif JP', serif; }

        /* SCREENS - CORRECCIÓN DE SCROLL */
        .screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 80px; /* Deja espacio para la nav */
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; /* Permite scroll interno */
            -webkit-overflow-scrolling: touch;
            padding-bottom: 40px; /* Padding extra para no chocar con la nav */
            z-index: 1;
        }
        .screen.active { display: flex; animation: screenIn 0.3s ease; }
        
        @keyframes screenIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER & ENSO */
        #screen-home { padding: 0 28px; }
        .home-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 24px 0 0; }
        .home-greeting { font-family: 'Shippori Mincho', serif; font-size: 0.95rem; color: var(--indigo); }
        
        .enso-container { display: flex; flex-direction: column; align-items: center; margin: 30px 0; position: relative; }
        .enso { width: 220px; height: 220px; position: relative; display: flex; align-items: center; justify-content: center; }
        .enso svg { position: absolute; inset: 0; width: 100%; height: 100%; }
        .enso svg path { stroke-dasharray: 600; animation: brushStroke 2s ease-out forwards; stroke: var(--ink); stroke-width: 5; fill: none; }
        @keyframes brushStroke { from { stroke-dashoffset: 600; } to { stroke-dashoffset: 0; } }
        
        .enso-num { font-family: 'Shippori Mincho', serif; font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .enso-sub { font-size: 0.6rem; letter-spacing: 4px; color: var(--indigo); text-transform: uppercase; margin-top: 5px; font-weight: 700; }

        /* STATS */
        .stats-row { display: flex; width: 100%; border-top: 1px solid var(--indigo-ghost); border-bottom: 1px solid var(--indigo-ghost); }
        .stat-cell { flex: 1; text-align: center; padding: 15px 5px; cursor: pointer; }
        .stat-num { font-family: 'Shippori Mincho', serif; font-size: 1.5rem; font-weight: 700; }
        .stat-lbl { font-size: 0.5rem; letter-spacing: 2px; color: var(--indigo); text-transform: uppercase; }

        /* FORMULARIO */
        #screen-add { padding: 0 28px; }
        .fg { width: 100%; margin-bottom: 20px; }
        .fg-label { font-size: 0.6rem; letter-spacing: 2px; color: var(--indigo); text-transform: uppercase; margin-bottom: 5px; font-weight: 700; }
        .fg-input {
            background: transparent; border: none; border-bottom: 2px solid var(--indigo-pale);
            font-family: 'Shippori Mincho', serif; font-size: 1.2rem; color: var(--ink);
            padding: 10px 0; width: 100%; outline: none;
        }
        
        .qty-row { display: flex; align-items: center; gap: 15px; }
        .q-btn { width: 40px; height: 40px; border-radius: 50%; border: 1.5px solid var(--indigo-pale); background: transparent; font-size: 1.2rem; color: var(--indigo); }
        .q-val { font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: 700; width: 40px; text-align: center; }

        .chips { display: flex; gap: 10px; overflow-x: auto; width: 100%; padding: 5px 0; -webkit-overflow-scrolling: touch; }
        .chip {
            min-width: 70px; height: 85px; background: var(--white); border: 1.5px solid var(--indigo-ghost);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; border-radius: var(--radius); flex-shrink: 0;
        }
        .chip.sel { background: var(--ink); color: white; border-color: var(--ink); }
        .chip svg { width: 22px; height: 22px; stroke: currentColor; fill: none; margin-bottom: 5px; }
        .chip-lbl { font-size: 0.55rem; text-align: center; font-weight: 600; }

        .dg { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        .d-btn {
            padding: 15px 5px; background: var(--white); border: 1.5px solid var(--indigo-ghost);
            font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase; font-weight: 700; border-radius: var(--radius);
        }
        .d-btn.sel { border-color: var(--ink); color: var(--ink); }
        .d-btn.sel-v { border-color: var(--vermillion); color: var(--vermillion); background: var(--vermillion-pale); }
        .d-btn.w2 { grid-column: span 2; }

        .pb { width: 100%; display: none; margin-top: 10px; text-align: center; }
        .pb-inp {
            background: transparent; border: none; border-bottom: 2px solid var(--vermillion);
            font-family: 'Shippori Mincho', serif; font-size: 1.5rem; color: var(--vermillion);
            text-align: center; padding: 10px 0; width: 100%; outline: none; font-weight: 700;
        }

        .cta {
            margin: 25px 0; padding: 18px; background: var(--ink); color: white;
            border: none; font-size: 0.7rem; letter-spacing: 4px; text-transform: uppercase;
            font-weight: 700; border-radius: var(--radius); width: 100%; cursor: pointer;
        }

        /* LISTAS */
        .ic { width: 92%; margin: 0 auto 10px; background: var(--white); border: 1px solid rgba(107,143,163,0.08); padding: 15px; border-radius: var(--radius); }
        .ic-top { display: flex; justify-content: space-between; align-items: center; }
        .ic-n { font-family: 'Shippori Mincho', serif; font-size: 1rem; font-weight: 600; }
        .ic-p { font-family: 'Shippori Mincho', serif; font-size: 0.9rem; font-weight: 700; color: var(--indigo); }
        .ic-p.won { color: var(--vermillion); }
        .ic-bot { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--indigo-ghost); }

        .cb { background: none; border: 1.5px solid var(--indigo-ghost); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .cb svg { width: 18px; height: 18px; stroke: var(--indigo); fill: none; }

        /* MODALS */
        .ov {
            position: fixed; inset: 0; background: rgba(247,245,240,0.98);
            z-index: 2000; display: none; flex-direction: column; align-items: center;
            justify-content: center; padding: 30px;
        }
        .ov.visible { display: flex; }

        /* NAV - FIJADA ABAJO */
        .nav {
            position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--washi);
            border-top: 1px solid var(--indigo-ghost); display: flex; justify-content: space-around;
            align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .ni { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.4; }
        .ni.on { opacity: 1; }
        .ni svg { width: 22px; height: 22px; stroke: var(--ink); fill: none; }
        .nt { font-size: 0.5rem; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--ink); color: white; padding: 12px 25px; border-radius: 20px;
            font-size: 0.8rem; z-index: 5000; opacity: 0; transition: 0.3s;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<div id="screen-home" class="screen active">
    <div class="home-header">
        <div class="home-greeting jp" id="greeting">空白</div>
        <div class="home-ver">v20 Plus</div>
    </div>
    <div class="enso-container">
        <div class="enso">
            <svg viewBox="0 0 200 200"><path d="M100 12 C160 12,190 48,190 100 C190 155,158 190,100 190 C42 190,10 155,10 100 C10 50,38 18,78 13"/></svg>
            <div class="enso-center">
                <div class="enso-num jp" id="total-money">0</div>
                <div class="enso-sub">ganado €</div>
            </div>
        </div>
    </div>
    <div class="stats-row">
        <div class="stat-cell" onclick="go('screen-santuario', navButtons[2])">
            <div class="stat-num jp" id="stat-kept">0</div>
            <div class="stat-lbl">Santuario</div>
        </div>
        <div class="stat-cell" onclick="go('screen-list', navButtons[3])">
            <div class="stat-num jp" id="stat-pending">0</div>
            <div class="stat-lbl">Pendiente</div>
        </div>
        <div class="stat-cell">
            <div class="stat-num jp" id="stat-sold" style="color:var(--vermillion)">0</div>
            <div class="stat-lbl">Vendidos</div>
        </div>
    </div>
</div>

<div id="screen-add" class="screen">
    <div style="width:100%; padding-top: 20px;">
        <div class="fg">
            <div class="fg-label">Nombre del objeto</div>
            <input class="fg-input jp" type="text" id="inp-name" placeholder="Ej: Jarrón antiguo" autocomplete="off">
        </div>
        <div class="fg">
            <div class="fg-label">Cantidad</div>
            <div class="qty-row">
                <button class="q-btn" onclick="adjustQty(-1)">−</button>
                <span class="q-val jp" id="add-qty">1</span>
                <button class="q-btn" onclick="adjustQty(1)">+</button>
            </div>
        </div>
        <div class="fg">
            <div class="fg-label">Espacio</div>
            <div class="chips" id="add-chips"></div>
        </div>
        <div class="fg">
            <div class="fg-label">¿Qué vas a hacer?</div>
            <div class="dg" id="decision-grid"></div>
        </div>
        <div class="pb" id="price-box">
            <div class="fg-label" style="color:var(--vermillion)">Precio esperado (€)</div>
            <input class="pb-inp jp" type="text" id="inp-price" placeholder="0" inputmode="decimal" pattern="[0-9]*">
        </div>
        <button class="cta" onclick="saveNewItem()">REGISTRAR OBJETO</button>
    </div>
</div>

<div id="screen-santuario" class="screen">
    <div class="sant-top">
        <div class="sant-kanji jp">聖域</div>
        <input class="sant-search jp" type="text" id="sant-q" placeholder="Buscar en santuario..." oninput="renderSantuario()">
    </div>
    <div class="rooms" id="rooms" style="width:100%;"></div>
</div>

<div id="screen-list" class="screen">
    <div class="tabs">
        <button class="tab on" onclick="switchTab('process')">Proceso</button>
        <button class="tab" onclick="switchTab('sold')">Cuentas</button>
    </div>
    <div id="list-content" style="width:100%; padding-top:20px;"></div>
</div>

<div id="screen-settings" class="screen">
    <div style="padding-top:40px; width:100%; padding-left:28px; padding-right:28px;">
        <button class="cta" onclick="exportData()">GUARDAR COPIA (JSON)</button>
        <button class="cta2" onclick="document.getElementById('file-input').click()" style="width:100%; padding:15px; border:1px solid var(--indigo); border-radius:4px; background:none; color:var(--indigo); font-weight:700;">CARGAR COPIA</button>
        <input type="file" id="file-input" style="display:none" accept=".json" onchange="importData(this)">
        <button class="cta" style="background:var(--vermillion); margin-top:50px;" onclick="confirmAction('¿Borrar TODO?', resetAll)">RESETEAR APP</button>
    </div>
</div>

<div id="ov-sold" class="ov">
    <div class="fg-label">Precio final de venta</div>
    <input class="pb-inp jp" type="text" id="sold-price" placeholder="0" inputmode="decimal" style="font-size:3rem;">
    <button class="cta" onclick="confirmSold()">CONFIRMAR VENTA</button>
    <button class="cta" style="background:none; color:var(--indigo);" onclick="closeOverlay('ov-sold')">CANCELAR</button>
</div>

<div id="ov-confirm" class="ov">
    <p id="confirm-msg" style="margin-bottom:20px; font-weight:700;"></p>
    <button class="cta" id="confirm-yes">SÍ, ESTOY SEGURO</button>
    <button class="cta" style="background:none; color:var(--indigo);" onclick="closeOverlay('ov-confirm')">CANCELAR</button>
</div>

<div class="toast" id="toast"></div>

<nav class="nav">
    <button class="ni on" onclick="go('screen-home', this)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/></svg><span class="nt">Inicio</span></button>
    <button class="ni" onclick="go('screen-add', this)"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg><span class="nt">Nuevo</span></button>
    <button class="ni" onclick="go('screen-santuario', this)"><svg viewBox="0 0 24 24"><path d="M3 21h18M5 21V7l7-4 7 4v14"/></svg><span class="nt">Zen</span></button>
    <button class="ni" onclick="go('screen-list', this)"><svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10"/></svg><span class="nt">Lista</span></button>
    <button class="ni" onclick="go('screen-settings', this)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v2M12 20v2"/></svg><span class="nt">Config</span></button>
</nav>

<script>
let db = JSON.parse(localStorage.getItem('kuhakuDB') || '[]');
let state = { currentAction: null, currentTab: 'process', addSpace: 'living', addQty: 1, soldId: null, openRooms: new Set() };
const navButtons = document.querySelectorAll('.ni');

const SPACES = [
    { id: 'living', icon: '<svg viewBox="0 0 24 24"><path d="M4 18v-5a3 3 0 013-3h10a3 3 0 013 3v5"/></svg>', label: 'Sala' },
    { id: 'bedroom', icon: '<svg viewBox="0 0 24 24"><path d="M2 18h20M4 18v-7a2 2 0 012-2h12a2 2 0 012 2v7"/></svg>', label: 'Cama' },
    { id: 'kitchen', icon: '<svg viewBox="0 0 24 24"><path d="M4 12h16v5a5 5 0 01-5 5H9a5 5 0 01-5-5v-5z"/></svg>', label: 'Cocina' },
    { id: 'bath', icon: '<svg viewBox="0 0 24 24"><path d="M4 14h16v4a4 4 0 01-4 4H8a4 4 0 01-4-4v-4z"/></svg>', label: 'Baño' }
];

const DECISIONS = [
    { id: 'conservar', label: 'Santuario' },
    { id: 'regalar', label: 'Regalar' },
    { id: 'donar', label: 'Donar' },
    { id: 'tirar', label: 'Tirar' },
    { id: 'vender', label: 'Vender', wide: true }
];

function saveData() { localStorage.setItem('kuhakuDB', JSON.stringify(db)); updateHome(); }

function go(id, btn) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    navButtons.forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
    // Reiniciar scroll al cambiar pantalla
    document.getElementById(id).scrollTop = 0;
    if (id === 'screen-list') renderList();
    if (id === 'screen-santuario') renderSantuario();
}

function adjustQty(delta) { 
    state.addQty = Math.max(1, state.addQty + delta); 
    document.getElementById('add-qty').textContent = state.addQty; 
}

function renderAddForm() {
    const chips = document.getElementById('add-chips');
    chips.innerHTML = SPACES.map(s => `
        <div class="chip ${s.id === state.addSpace ? 'sel' : ''}" onclick="state.addSpace='${s.id}'; renderAddForm();">
            ${s.icon}<div class="chip-lbl">${s.label}</div>
        </div>
    `).join('');

    const grid = document.getElementById('decision-grid');
    grid.innerHTML = DECISIONS.map(d => `
        <button class="d-btn ${d.wide ? 'w2' : ''} ${state.currentAction === d.id ? (d.id === 'vender' ? 'sel-v' : 'sel') : ''}" 
                onclick="state.currentAction='${d.id}'; document.getElementById('price-box').style.display = '${d.id === 'vender' ? 'block' : 'none'}'; renderAddForm();">
            ${d.label}
        </button>
    `).join('');
}

function saveNewItem() {
    const name = document.getElementById('inp-name').value;
    if (!name || !state.currentAction) { showToast('Nombre y decisión obligatorios'); return; }
    const item = {
        id: Date.now(), name, qty: state.addQty, act: state.currentAction,
        space: state.addSpace, price: parseFloat(document.getElementById('inp-price').value) || 0,
        final: 0, st: state.currentAction === 'conservar' ? 'kept' : 'active'
    };
    db.push(item); saveData();
    showToast('¡Guardado!');
    // Limpiar campos
    document.getElementById('inp-name').value = '';
    document.getElementById('inp-price').value = '';
    state.addQty = 1; document.getElementById('add-qty').textContent = '1';
    state.currentAction = null; renderAddForm();
    go('screen-home', navButtons[0]);
}

function renderSantuario() {
    const items = db.filter(i => i.st === 'kept');
    document.getElementById('rooms').innerHTML = items.map(i => `
        <div class="ic">
            <div class="ic-top"><span class="ic-n">${i.name}</span> <span class="ic-p">Zen</span></div>
            <div class="ic-bot">
                <button class="cb" onclick="moveItem(${i.id}, 'active')"><svg viewBox="0 0 24 24"><path d="M17 8l4 4-4 4M3 12h18"/></svg></button>
                <button class="cb" onclick="deleteItem(${i.id})">×</button>
            </div>
        </div>
    `).join('');
}

function switchTab(t) { state.currentTab = t; renderList(); }

function renderList() {
    const list = db.filter(i => i.st === (state.currentTab === 'process' ? 'active' : 'done'));
    document.getElementById('list-content').innerHTML = list.map(i => `
        <div class="ic">
            <div class="ic-top"><span class="ic-n">${i.name}</span> <span class="ic-p ${state.currentTab === 'sold' ? 'won' : ''}">${state.currentTab === 'process' ? i.price+'€' : '+'+i.final+'€'}</span></div>
            <div class="ic-bot">
                ${state.currentTab === 'process' ? 
                    `<button class="cta" style="margin:0; padding:8px 15px;" onclick="${i.act==='vender' ? 'openSold('+i.id+')' : 'moveItem('+i.id+',\'done\')'}">${i.act==='vender' ? 'Vendido' : 'Hecho'}</button>` : 
                    `<button class="cb" onclick="moveItem(${i.id}, 'kept')">Zen</button>`
                }
                <button class="cb" onclick="deleteItem(${i.id})">×</button>
            </div>
        </div>
    `).join('');
}

function moveItem(id, st) { 
    const i = db.find(x => x.id == id); 
    if(i) { i.st = st; saveData(); renderList(); renderSantuario(); } 
}

function deleteItem(id) { 
    confirmAction('¿Eliminar este objeto?', () => { db = db.filter(x => x.id != id); saveData(); renderList(); renderSantuario(); }); 
}

function openSold(id) { state.soldId = id; document.getElementById('ov-sold').classList.add('visible'); }
function confirmSold() {
    const p = parseFloat(document.getElementById('sold-price').value) || 0;
    const i = db.find(x => x.id == state.soldId);
    if(i) { i.final = p; i.st = 'done'; saveData(); closeOverlay('ov-sold'); renderList(); }
}

function closeOverlay(id) { document.getElementById(id).classList.remove('visible'); }
function confirmAction(m, cb) {
    document.getElementById('confirm-msg').textContent = m;
    document.getElementById('ov-confirm').classList.add('visible');
    document.getElementById('confirm-yes').onclick = () => { cb(); closeOverlay('ov-confirm'); };
}

function resetAll() { db = []; saveData(); location.reload(); }
function updateHome() {
    const earned = db.filter(i => i.st === 'done').reduce((acc, x) => acc + x.final, 0);
    document.getElementById('total-money').textContent = earned;
    document.getElementById('stat-kept').textContent = db.filter(i => i.st === 'kept').length;
    document.getElementById('stat-pending').textContent = db.filter(i => i.st === 'active').length;
    document.getElementById('stat-sold').textContent = db.filter(i => i.st === 'done').length;
}

function showToast(m) { 
    const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); 
    setTimeout(() => t.classList.remove('show'), 2000); 
}

// Init
renderAddForm();
updateHome();
</script>
</body>
</html>
